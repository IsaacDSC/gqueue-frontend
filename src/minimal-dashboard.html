<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GQueue Dashboard - Minimal Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {</script>
            darkMode: 'class',
            theme: {
                extend: {}
            }
        }
    </script>
    <style>
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">GQueue Dashboard (Minimal)</h1>
                    <div class="text-sm text-gray-600">
                        Config Status: <span id="config-status">Checking...</span>
                    </div>
                </div>
                <div class="space-x-2">
                    <button id="test-config" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">Test Config</button>
                    <button id="test-api" class="px-3 py-2 bg-green-600 text-white rounded text-sm">Test API</button>
                    <button id="go-setup" class="px-3 py-2 bg-purple-600 text-white rounded text-sm">Setup</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Status Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Config Status -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold mb-4">Configuration</h3>
                <div class="space-y-2 text-sm">
                    <div>Server URL: <span id="server-url">-</span></div>
                    <div>Has Token: <span id="has-token">-</span></div>
                    <div>Config Valid: <span id="config-valid">-</span></div>
                </div>
            </div>

            <!-- API Status -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold mb-4">API Connection</h3>
                <div class="space-y-2 text-sm">
                    <div>Status: <span id="api-status">Not tested</span></div>
                    <div>Response Time: <span id="response-time">-</span></div>
                    <div>Last Check: <span id="last-check">Never</span></div>
                </div>
            </div>

            <!-- Events Status -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold mb-4">Events</h3>
                <div class="space-y-2 text-sm">
                    <div>Count: <span id="events-count">0</span></div>
                    <div>Source: <span id="events-source">None</span></div>
                    <div>Last Updated: <span id="events-updated">Never</span></div>
                </div>
            </div>
        </div>

        <!-- Simple Events List -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="px-6 py-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Events</h3>
                    <button id="load-events" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">Load Events</button>
                </div>
            </div>
            <div class="p-6">
                <div id="events-list">
                    <p class="text-gray-500">No events loaded</p>
                </div>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="mt-8 bg-gray-100 rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-4">Debug Log</h3>
            <div id="debug-log" class="bg-white p-4 rounded border h-64 overflow-y-auto text-sm font-mono">
                Starting minimal dashboard...<br>
            </div>
        </div>
    </main>

    <script>
        // Debug logging
        const debugLog = document.getElementById('debug-log');
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[Dashboard] ${message}`);
        }

        // Configuration management
        function loadConfig() {
            log("Loading configuration from localStorage...");

            const configRaw = localStorage.getItem('gqueue-config');
            log(`Raw config: ${configRaw}`);

            if (!configRaw) {
                log("❌ No configuration found");
                document.getElementById('config-status').textContent = 'Missing';
                document.getElementById('config-valid').textContent = 'No';
                return null;
            }

            try {
                const config = JSON.parse(configRaw);
                log(`✅ Configuration parsed successfully`);

                document.getElementById('config-status').textContent = 'Found';
                document.getElementById('server-url').textContent = config.serverUrl || 'Not set';
                document.getElementById('has-token').textContent = config.authToken ? 'Yes' : 'No';
                document.getElementById('config-valid').textContent = config.serverUrl ? 'Yes' : 'No';

                log(`Server URL: ${config.serverUrl}`);
                log(`Has token: ${!!config.authToken}`);

                return config;
            } catch (error) {
                log(`❌ Configuration parse error: ${error.message}`);
                document.getElementById('config-status').textContent = 'Invalid';
                document.getElementById('config-valid').textContent = 'No';
                return null;
            }
        }

        // API testing
        async function testAPI() {
            log("Testing API connection...");

            const config = loadConfig();
            if (!config || !config.serverUrl) {
                log("❌ No valid configuration for API test");
                document.getElementById('api-status').textContent = 'No config';
                return;
            }

            const startTime = Date.now();
            document.getElementById('api-status').textContent = 'Testing...';

            try {
                const headers = {
                    'Accept': 'application/json'
                };

                if (config.authToken) {
                    headers['Authorization'] = `Bearer ${config.authToken}`;
                    log(`Using authentication token`);
                }

                log(`Testing: ${config.serverUrl}/api/v1/ping`);

                const response = await fetch(`${config.serverUrl}/api/v1/ping`, {
                    method: 'GET',
                    headers: headers,
                    signal: AbortSignal.timeout(10000)
                });

                const endTime = Date.now();
                const responseTime = endTime - startTime;

                document.getElementById('response-time').textContent = `${responseTime}ms`;
                document.getElementById('last-check').textContent = new Date().toLocaleTimeString();

                if (response.ok) {
                    log(`✅ API connection successful: ${response.status} (${responseTime}ms)`);
                    document.getElementById('api-status').textContent = 'Connected';
                    return true;
                } else {
                    log(`❌ API connection failed: HTTP ${response.status}`);
                    document.getElementById('api-status').textContent = `Error ${response.status}`;
                    return false;
                }
            } catch (error) {
                const endTime = Date.now();
                const responseTime = endTime - startTime;

                document.getElementById('response-time').textContent = `${responseTime}ms (timeout)`;
                document.getElementById('last-check').textContent = new Date().toLocaleTimeString();

                if (error.name === 'TimeoutError') {
                    log(`❌ API connection timeout after 10 seconds`);
                    document.getElementById('api-status').textContent = 'Timeout';
                } else {
                    log(`❌ API connection error: ${error.message}`);
                    document.getElementById('api-status').textContent = 'Error';
                }
                return false;
            }
        }

        // Events loading
        async function loadEvents() {
            log("Loading events from API...");

            const config = loadConfig();
            if (!config || !config.serverUrl) {
                log("❌ No valid configuration for events");
                return;
            }

            try {
                const headers = {
                    'Accept': 'application/json'
                };

                if (config.authToken) {
                    headers['Authorization'] = `Bearer ${config.authToken}`;
                }

                log(`Fetching: ${config.serverUrl}/api/v1/events`);

                const response = await fetch(`${config.serverUrl}/api/v1/events`, {
                    method: 'GET',
                    headers: headers,
                    signal: AbortSignal.timeout(10000)
                });

                if (response.ok) {
                    const events = await response.json();
                    log(`✅ Events loaded successfully: ${events.length} events`);

                    document.getElementById('events-count').textContent = events.length;
                    document.getElementById('events-source').textContent = 'API';
                    document.getElementById('events-updated').textContent = new Date().toLocaleTimeString();

                    displayEvents(events);
                } else {
                    log(`❌ Events loading failed: HTTP ${response.status}`);
                    document.getElementById('events-source').textContent = 'Error';
                }
            } catch (error) {
                log(`❌ Events loading error: ${error.message}`);
                document.getElementById('events-source').textContent = 'Error';
            }
        }

        // Display events
        function displayEvents(events) {
            const container = document.getElementById('events-list');

            if (events.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No events found</p>';
                return;
            }

            container.innerHTML = events.map(event => `
                <div class="border rounded p-4 mb-2">
                    <h4 class="font-semibold">${event.name || 'Unknown Event'}</h4>
                    <p class="text-sm text-gray-600">Service: ${event.service_name || 'Unknown'}</p>
                    <p class="text-sm text-gray-600">Team: ${event.team_owner || 'Unknown'}</p>
                    <p class="text-sm text-gray-600">Triggers: ${event.triggers ? event.triggers.length : 0}</p>
                </div>
            `).join('');
        }

        // Button handlers
        document.getElementById('test-config').addEventListener('click', () => {
            log("Manual configuration test triggered");
            loadConfig();
        });

        document.getElementById('test-api').addEventListener('click', () => {
            log("Manual API test triggered");
            testAPI();
        });

        document.getElementById('load-events').addEventListener('click', () => {
            log("Manual events load triggered");
            loadEvents();
        });

        document.getElementById('go-setup').addEventListener('click', () => {
            log("Redirecting to setup page");
            window.location.href = 'setup.html';
        });

        // Auto-initialization
        document.addEventListener('DOMContentLoaded', () => {
            log("DOM loaded, starting initialization...");

            // Test configuration
            const config = loadConfig();

            if (config && config.serverUrl) {
                log("Configuration valid, testing API connection...");
                testAPI().then(success => {
                    if (success) {
                        log("API connected, loading events...");
                        loadEvents();
                    }
                });
            } else {
                log("No valid configuration found, manual setup required");
            }
        });
    </script>
</body>
</html>
