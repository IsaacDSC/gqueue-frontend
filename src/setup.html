<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>GQueue - Server Setup</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {},
                },
            };
        </script>
        <style>
            * {
                transition:
                    background-color 0.3s ease,
                    color 0.3s ease,
                    border-color 0.3s ease;
            }
            .setup-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
        </style>
    </head>
    <body class="setup-bg min-h-screen">
        <div class="min-h-screen flex items-center justify-center py-12 px-4">
            <div class="max-w-md w-full">
                <!-- Header -->
                <div class="text-center mb-8">
                    <div
                        class="mx-auto h-16 w-16 bg-white rounded-full flex items-center justify-center shadow-lg mb-4"
                    >
                        <svg
                            class="h-8 w-8 text-blue-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                            ></path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-white mb-2">
                        GQueue Dashboard
                    </h1>
                    <p class="text-gray-200">
                        Configure your server to get started
                    </p>
                </div>

                <!-- Setup Form -->
                <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6">
                    <form id="setup-form" class="space-y-6">
                        <!-- Server URL -->
                        <div>
                            <label
                                for="serverUrl"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                            >
                                Server URL
                            </label>
                            <input
                                type="url"
                                id="serverUrl"
                                name="serverUrl"
                                value="http://localhost:8080"
                                placeholder="http://localhost:8080"
                                required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                            <p class="mt-1 text-xs text-gray-500">
                                Enter the base URL of your GQueue API server
                            </p>
                        </div>

                        <!-- Auth Token -->
                        <div>
                            <label
                                for="authToken"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                            >
                                Authentication Token
                                <span class="text-gray-400">(Optional)</span>
                            </label>
                            <div class="relative">
                                <input
                                    type="password"
                                    id="authToken"
                                    name="authToken"
                                    placeholder="Enter your API token (optional)"
                                    class="w-full px-4 py-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                />
                                <button
                                    type="button"
                                    id="togglePassword"
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center"
                                    tabindex="-1"
                                >
                                    <svg
                                        class="w-5 h-5 text-gray-400 hover:text-gray-600"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                        ></path>
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                        ></path>
                                    </svg>
                                </button>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">
                                Optional Bearer token for API authentication
                            </p>
                        </div>

                        <!-- Status Area -->
                        <div
                            id="status-area"
                            class="hidden p-4 rounded-lg border"
                        >
                            <div id="status-message" class="flex items-center">
                                <div id="status-spinner" class="hidden mr-3">
                                    <svg
                                        class="w-5 h-5 animate-spin text-blue-600"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                        ></path>
                                    </svg>
                                </div>
                                <span id="status-text"
                                    >Testing connection...</span
                                >
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="flex space-x-3">
                            <button
                                type="button"
                                id="test-btn"
                                class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                            >
                                Test Connection
                            </button>
                            <button
                                type="submit"
                                id="connect-btn"
                                class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                            >
                                Connect & Start
                            </button>
                        </div>
                    </form>

                    <!-- Saved Configurations -->
                    <div
                        id="saved-configs"
                        class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-600 hidden"
                    >
                        <h3
                            class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3"
                        >
                            Recent Connections
                        </h3>
                        <div id="configs-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Debug function
            function log(message) {
                console.log(`[Setup] ${message}`);
            }

            class SetupManager {
                constructor() {
                    this.form = document.getElementById("setup-form");
                    this.testBtn = document.getElementById("test-btn");
                    this.connectBtn = document.getElementById("connect-btn");
                    this.statusArea = document.getElementById("status-area");
                    this.statusText = document.getElementById("status-text");
                    this.statusSpinner =
                        document.getElementById("status-spinner");
                    this.togglePasswordBtn =
                        document.getElementById("togglePassword");
                    this.authTokenInput = document.getElementById("authToken");

                    // Initially disable connect button
                    this.connectBtn.disabled = true;
                    this.connectBtn.classList.add("opacity-50");

                    this.bindEvents();
                    this.loadSavedConfigs();
                    log("SetupManager initialized");
                }

                bindEvents() {
                    this.form.addEventListener("submit", (e) => {
                        e.preventDefault();
                        this.handleConnect();
                    });

                    this.testBtn.addEventListener("click", () => {
                        this.testConnection();
                    });

                    this.togglePasswordBtn.addEventListener("click", () => {
                        this.togglePasswordVisibility();
                    });

                    // Auto-test when URL changes
                    document
                        .getElementById("serverUrl")
                        .addEventListener("blur", () => {
                            const url =
                                document.getElementById("serverUrl").value;
                            if (url && this.isValidUrl(url)) {
                                this.testConnection();
                            }
                        });
                }

                async testConnection() {
                    const url = document.getElementById("serverUrl").value;
                    const token = document.getElementById("authToken").value;

                    if (!url) {
                        this.showStatus("Please enter a server URL", "error");
                        return;
                    }

                    if (!this.isValidUrl(url)) {
                        this.showStatus("Please enter a valid URL", "error");
                        return;
                    }

                    this.showStatus("Testing connection...", "loading");
                    this.testBtn.disabled = true;

                    try {
                        const headers = {
                            Accept: "application/json",
                        };

                        if (token) {
                            headers["Authorization"] = `Bearer ${token}`;
                        }

                        const response = await fetch(`${url}/api/v1/ping`, {
                            method: "GET",
                            headers: headers,
                            signal: AbortSignal.timeout(10000),
                        });

                        if (response.ok) {
                            this.showStatus(
                                "✅ Connection successful!",
                                "success",
                            );
                            this.connectBtn.disabled = false;
                            this.connectBtn.classList.remove("opacity-50");
                        } else {
                            this.showStatus(
                                `❌ Connection failed: HTTP ${response.status}`,
                                "error",
                            );
                        }
                    } catch (error) {
                        if (error.name === "TimeoutError") {
                            this.showStatus(
                                "❌ Connection timeout (10s)",
                                "error",
                            );
                        } else {
                            this.showStatus(
                                `❌ Connection failed: ${error.message}`,
                                "error",
                            );
                        }
                    } finally {
                        this.testBtn.disabled = false;
                    }
                }

                async handleConnect() {
                    const url = document.getElementById("serverUrl").value;
                    const token = document.getElementById("authToken").value;

                    if (!url) {
                        this.showStatus("Please enter a server URL", "error");
                        return;
                    }

                    // Save configuration
                    const config = {
                        serverUrl: url,
                        authToken: token || null,
                        apiTimeout: 10000,
                        autoRefreshEnabled: true,
                        autoRefreshInterval: 60000,
                        timestamp: new Date().toISOString(),
                    };

                    this.saveConfig(config);

                    // Set global configuration
                    window.GQUEUE_CONFIG = {
                        apiBaseUrl: url,
                        authToken: token || null,
                        apiTimeout: 10000,
                        autoRefreshEnabled: true,
                        autoRefreshInterval: 60000,
                    };

                    // Store in localStorage for the main app
                    localStorage.setItem(
                        "gqueue-config",
                        JSON.stringify(config),
                    );

                    // Verify the config was saved
                    const savedConfig = localStorage.getItem("gqueue-config");
                    log(`Config saved: ${savedConfig}`);

                    this.showStatus("🚀 Starting dashboard...", "loading");

                    // Redirect to main dashboard
                    setTimeout(() => {
                        window.location.href = "index.html";
                    }, 1000);
                }

                showStatus(message, type) {
                    this.statusArea.classList.remove("hidden");
                    this.statusText.textContent = message;

                    // Reset classes
                    this.statusArea.className = "p-4 rounded-lg border";

                    if (type === "loading") {
                        this.statusSpinner.classList.remove("hidden");
                        this.statusArea.classList.add(
                            "bg-blue-50",
                            "border-blue-200",
                            "text-blue-700",
                        );
                    } else {
                        this.statusSpinner.classList.add("hidden");
                        if (type === "success") {
                            this.statusArea.classList.add(
                                "bg-green-50",
                                "border-green-200",
                                "text-green-700",
                            );
                        } else if (type === "error") {
                            this.statusArea.classList.add(
                                "bg-red-50",
                                "border-red-200",
                                "text-red-700",
                            );
                        }
                    }
                }

                togglePasswordVisibility() {
                    const type =
                        this.authTokenInput.type === "password"
                            ? "text"
                            : "password";
                    this.authTokenInput.type = type;
                }

                isValidUrl(string) {
                    try {
                        new URL(string);
                        return true;
                    } catch (_) {
                        return false;
                    }
                }

                saveConfig(config) {
                    const saved = JSON.parse(
                        localStorage.getItem("gqueue-saved-configs") || "[]",
                    );

                    // Remove duplicates and add new config
                    const filtered = saved.filter(
                        (c) => c.serverUrl !== config.serverUrl,
                    );
                    filtered.unshift(config);

                    // Keep only last 5 configs
                    const toSave = filtered.slice(0, 5);
                    localStorage.setItem(
                        "gqueue-saved-configs",
                        JSON.stringify(toSave),
                    );
                }

                loadSavedConfigs() {
                    const saved = JSON.parse(
                        localStorage.getItem("gqueue-saved-configs") || "[]",
                    );

                    if (saved.length > 0) {
                        const savedConfigsDiv =
                            document.getElementById("saved-configs");
                        const configsList =
                            document.getElementById("configs-list");

                        savedConfigsDiv.classList.remove("hidden");

                        configsList.innerHTML = saved
                            .map(
                                (config, index) => `
                            <button
                                onclick="setupManager.loadConfig(${index})"
                                class="w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                            >
                                <div class="font-medium text-sm text-gray-900 dark:text-gray-100">${config.serverUrl}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    ${config.authToken ? "With token" : "No token"} • ${new Date(config.timestamp).toLocaleDateString()}
                                </div>
                            </button>
                        `,
                            )
                            .join("");
                    }
                }

                loadConfig(index) {
                    const saved = JSON.parse(
                        localStorage.getItem("gqueue-saved-configs") || "[]",
                    );
                    const config = saved[index];

                    if (config) {
                        document.getElementById("serverUrl").value =
                            config.serverUrl || "";
                        document.getElementById("authToken").value =
                            config.authToken || "";
                        this.testConnection();
                    }
                }
            }

            // Initialize when DOM is loaded
            let setupManager;
            document.addEventListener("DOMContentLoaded", () => {
                setupManager = new SetupManager();
            });
        </script>
    </body>
</html>
