<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>API Service Integration Test</h1>
        <p>This page tests the ManagerApi service integration with the dashboard.</p>

        <div class="test-section">
            <h3>1. API Service Initialization</h3>
            <button id="test-init">Test API Initialization</button>
            <div id="init-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. Ping Test</h3>
            <input type="text" id="ping-url" placeholder="API URL (e.g., http://localhost:8080)" style="width: 300px; padding: 5px;">
            <button id="test-ping">Test Ping</button>
            <div id="ping-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. Get Events Test</h3>
            <button id="test-get-events">Test Get Events</button>
            <div id="events-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Create Event Test</h3>
            <textarea id="event-data" placeholder='{"queueName": "test-queue", "exchange": "test-exchange", "routingKey": "test.key", "headers": {}, "properties": {}, "payload": "test message"}' style="width: 100%; height: 100px; padding: 5px;"></textarea>
            <button id="test-create-event">Test Create Event</button>
            <div id="create-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. Dashboard Integration Test</h3>
            <button id="test-dashboard">Test Dashboard with API</button>
            <div id="dashboard-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Test Log</h3>
            <button id="clear-log">Clear Log</button>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script src="services/api.js"></script>
    <script>
        let testApi = null;
        let dashboard = null;

        function log(message) {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toISOString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        // Test 1: API Service Initialization
        document.getElementById('test-init').addEventListener('click', () => {
            log('Testing API service initialization...');
            try {
                if (typeof ManagerApi === 'undefined') {
                    throw new Error('ManagerApi class not found');
                }

                testApi = new ManagerApi('http://localhost:8080', null, 5000);

                if (testApi && testApi.baseUrl && testApi.timeout) {
                    showResult('init-result', '✅ API service initialized successfully', 'success');
                    log('✅ API service initialized successfully');
                    log(`Base URL: ${testApi.baseUrl}`);
                    log(`Timeout: ${testApi.timeout}ms`);
                } else {
                    throw new Error('API service not properly initialized');
                }
            } catch (error) {
                showResult('init-result', `❌ Error: ${error.message}`, 'error');
                log(`❌ API initialization error: ${error.message}`);
            }
        });

        // Test 2: Ping Test
        document.getElementById('test-ping').addEventListener('click', async () => {
            const url = document.getElementById('ping-url').value || 'http://localhost:8080';
            log(`Testing ping to ${url}...`);

            try {
                if (!testApi) {
                    testApi = new ManagerApi(url, null, 5000);
                } else {
                    testApi.baseUrl = url;
                }

                const isConnected = await testApi.ping();

                if (isConnected) {
                    showResult('ping-result', `✅ Ping successful to ${url}`, 'success');
                    log(`✅ Ping successful to ${url}`);
                } else {
                    showResult('ping-result', `❌ Ping failed to ${url}`, 'error');
                    log(`❌ Ping failed to ${url}`);
                }
            } catch (error) {
                showResult('ping-result', `❌ Error: ${error.message}`, 'error');
                log(`❌ Ping error: ${error.message}`);
            }
        });

        // Test 3: Get Events Test
        document.getElementById('test-get-events').addEventListener('click', async () => {
            log('Testing get events...');

            try {
                if (!testApi) {
                    throw new Error('API service not initialized. Run initialization test first.');
                }

                const result = await testApi.getEvents();

                if (result.status === 'SUCCESS') {
                    const eventCount = Array.isArray(result.data) ? result.data.length : 'unknown';
                    showResult('events-result', `✅ Events retrieved successfully (${eventCount} events)`, 'success');
                    log(`✅ Events retrieved successfully`);
                    log(`Events data: ${JSON.stringify(result.data, null, 2)}`);
                } else {
                    showResult('events-result', `❌ Failed to get events: ${result.error}`, 'error');
                    log(`❌ Failed to get events: ${result.error}`);
                }
            } catch (error) {
                showResult('events-result', `❌ Error: ${error.message}`, 'error');
                log(`❌ Get events error: ${error.message}`);
            }
        });

        // Test 4: Create Event Test
        document.getElementById('test-create-event').addEventListener('click', async () => {
            const eventDataText = document.getElementById('event-data').value;
            log('Testing create event...');

            try {
                if (!testApi) {
                    throw new Error('API service not initialized. Run initialization test first.');
                }

                if (!eventDataText.trim()) {
                    throw new Error('Event data is required');
                }

                const eventData = JSON.parse(eventDataText);
                const result = await testApi.createEvent(eventData);

                if (result.status === 'SUCCESS') {
                    showResult('create-result', '✅ Event created successfully', 'success');
                    log('✅ Event created successfully');
                    log(`Created event: ${JSON.stringify(result.data, null, 2)}`);
                } else {
                    showResult('create-result', `❌ Failed to create event: ${result.error}`, 'error');
                    log(`❌ Failed to create event: ${result.error}`);
                }
            } catch (error) {
                showResult('create-result', `❌ Error: ${error.message}`, 'error');
                log(`❌ Create event error: ${error.message}`);
            }
        });

        // Test 5: Dashboard Integration Test
        document.getElementById('test-dashboard').addEventListener('click', () => {
            log('Testing dashboard integration...');

            try {
                // Try to load dashboard script
                const script = document.createElement('script');
                script.src = 'app.js';
                script.onload = () => {
                    log('✅ Dashboard script loaded');

                    // Check if Dashboard class is available
                    setTimeout(() => {
                        try {
                            if (typeof Dashboard !== 'undefined') {
                                showResult('dashboard-result', '✅ Dashboard integration successful', 'success');
                                log('✅ Dashboard class available');
                                log('✅ Dashboard integration test completed successfully');
                            } else {
                                showResult('dashboard-result', '❌ Dashboard class not found', 'error');
                                log('❌ Dashboard class not available');
                            }
                        } catch (dashError) {
                            showResult('dashboard-result', `❌ Dashboard error: ${dashError.message}`, 'error');
                            log(`❌ Dashboard integration error: ${dashError.message}`);
                        }
                    }, 1000);
                };
                script.onerror = () => {
                    showResult('dashboard-result', '❌ Failed to load dashboard script', 'error');
                    log('❌ Failed to load dashboard script');
                };
                document.head.appendChild(script);

            } catch (error) {
                showResult('dashboard-result', `❌ Error: ${error.message}`, 'error');
                log(`❌ Dashboard integration error: ${error.message}`);
            }
        });

        // Clear log
        document.getElementById('clear-log').addEventListener('click', () => {
            document.getElementById('test-log').textContent = '';
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('API Integration Test page loaded');
            log('Click "Test API Initialization" to begin testing');

            // Set default values
            document.getElementById('ping-url').value = 'http://localhost:8080';
            document.getElementById('event-data').value = JSON.stringify({
                queueName: "test-queue",
                exchange: "test-exchange",
                routingKey: "test.key",
                headers: {},
                properties: {},
                payload: "test message from integration test"
            }, null, 2);
        });
    </script>
</body>
</html>
